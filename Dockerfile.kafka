FROM confluentinc/cp-kafka:7.4.1

USER root
RUN microdnf update -y \
    && microdnf install -y python39 python39-pip \
    && ln -sf /usr/bin/python3.9 /usr/bin/python3 \
    && python3 -m pip install --no-cache-dir importlib-metadata==4.8.3 \
        prometheus_client requests psycopg2-binary \
    && microdnf clean all
USER 1001

COPY kafka/metrics_sidecar.py /opt/metrics_sidecar.py
ENTRYPOINT ["/bin/sh", "-c", "python3 /opt/metrics_sidecar.py & exec /etc/confluent/docker/run"]
